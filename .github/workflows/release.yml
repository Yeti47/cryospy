name: Build and Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-linux-server:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Build capture-server
      run: |
        cd server/capture-server
        go mod tidy
        CGO_ENABLED=0 go build -tags release -ldflags "-s -w" -o capture-server .
        
    - name: Build dashboard
      run: |
        cd server/dashboard
        go mod tidy
        CGO_ENABLED=0 go build -tags release -ldflags "-s -w" -o dashboard .
        
    - name: Package Linux server binaries
      run: |
        mkdir -p release/server-linux
        cp server/capture-server/capture-server release/server-linux/
        cp server/dashboard/dashboard release/server-linux/
        cp server/config.example.json release/server-linux/
        cp scripts/install-server-linux.sh release/server-linux/
        cp scripts/setup-nginx-proxy.sh release/server-linux/
        chmod +x release/server-linux/*
        tar -czf cryospy-server-linux-amd64.tar.gz -C release/server-linux .
        
    - name: Upload Linux server artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cryospy-server-linux-amd64
        path: cryospy-server-linux-amd64.tar.gz

  create-release:
    needs: [build-linux-server]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: cryospy-server-linux-amd64
        path: cryospy-server-linux-amd64
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          cryospy-server-linux-amd64/cryospy-server-linux-amd64.tar.gz
        body: |
          ## CryoSpy Release ${{ github.ref_name }}
          
          ### Components Available
          - **Server Package (Linux)**: Contains capture-server and dashboard components
          - **Capture Client Container (Docker)**: Available from `ghcr.io/${{ github.repository_owner }}/cryospy-client`
          
          ### Linux Installation

          **Server Installation:**
          ```bash
          tar -xzf cryospy-server-linux-amd64.tar.gz
          cd cryospy-server-linux-amd64
          chmod +x install-server-linux.sh
          ./install-server-linux.sh --with-systemd
          ```
          
          **Client (Docker):**
          ```bash
          docker run --rm -it \
            --device /dev/video0:/dev/video0 \
            -v $(pwd)/client-config:/config \
            ghcr.io/${{ github.repository_owner }}/cryospy-client:latest
          ```
          Mount your `config.json` file inside `client-config/` before launching. The container reads `/config/config.json` and writes logs to `/config/logs`.
          
          **Automated Server Installation:**
          ```bash
          # Server with systemd services
          ./install-server-linux.sh --with-systemd --force
          ```
          
          ### Windows Support

          Windows binaries are not currently published via the automated release process.
          To run CryoSpy on Windows, build from source using the instructions in the repository README.
          
          ### Configuration
          - Server configurations are automatically created during installation
          - Client container persists configuration under `/config`
          - See the included config.example.json files for reference
          - **Proxy Authentication**: Both server and client support configurable proxy authentication for enhanced security
                    
          ### Quick Start
          
          **On Server Machine:**
          ```bash
          # After running installation script
          ./capture-server &
          ./dashboard &
          # Access dashboard at http://localhost:8080
          ```
          
          **On Client Machines:**
          ```bash
          docker run --rm -it \
            --device /dev/video0:/dev/video0 \
            -v $(pwd)/client-config:/config \
            ghcr.io/${{ github.repository_owner }}/cryospy-client:latest
          ```
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
